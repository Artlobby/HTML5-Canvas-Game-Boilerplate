function Timer(t,i){this.autoStart=t===void 0?!0:t,this.whileAnimating=i||!1,this.lastStartTime=0,this.lastDeltaTime=0,this.elapsedTime=0,this.running=!1,this.getDelta=function(){var t=0;if(this.running){var i=this.whileAnimating?App.physicsTimeElapsed:performance.now();t=(i-this.lastDeltaTime)/1e3,this.lastDeltaTime=i,this.elapsedTime+=t}return t},this.start=function(){this.running||(this.lastStartTime=this.lastDeltaTime=this.whileAnimating?App.physicsTimeElapsed:performance.now(),this.running=!0)},this.stop=function(){this.elapsedTime+=this.getDelta(),this.running=!1},this.getElapsedTime=function(){return this.getDelta(),this.elapsedTime},this.autoStart&&this.start()}function Collection(t){this.items=t||[]}function ImageWrapper(t,i,e,s,n){this.src=t,this.x=i,this.y=e,this.w=s,this.h=n,this.draw=function(){context.drawImage(this.src,this.x,this.y,this.w,this.h)}}function TileMap(t,i,e){var s,n,a,r;this.options={cellSize:[Box.prototype.DEFAULT_WIDTH,Box.prototype.DEFAULT_HEIGHT],gridSize:null},e&&e.cellSize instanceof Array&&e.cellSize.length>1&&(this.options.cellSize=e.cellSize),e&&e.gridSize instanceof Array&&e.gridSize.length>1&&(this.options.gridSize=e.gridSize),(i===void 0||null===i)&&(i=[]),(this.options.startCoords===void 0||0===this.options.startCoords.length)&&(this.options.startCoords=[0,world.height-this.options.cellSize[1]*("string"==typeof t?t.split("\n"):t).length]);var o=this.options.gridSize,h=this.options.cellSize[0],l=this.options.cellSize[1],c=this.options.startCoords[0],u=this.options.startCoords[1];if(o instanceof Array&&o.length>0)for(t=Array(o[0]),s=0;o[0]>s;s++)for(t[s]=Array(o[1]),n=0;o[1]>n;n++)t[s][n]=null;if("string"==typeof t)for(t=t.split("\n"),s=0,a=t.length;a>s;s++)t[s]=t[s].split("");for(this.grid=t,i!==void 0&&i[" "]===void 0&&(i[" "]=null),s=0,a=t.length;a>s;s++)for(n=0,r=t[s].length;r>n;n++)if(null!==t[s][n]){var f=i?i[t[s][n]]:t[s][n];if(null===f||void 0===f)this.grid[s][n]=null;else{var p=c+n*h,d=u+s*l;this.grid[s][n]="string"==typeof f||f instanceof Image||f instanceof HTMLImageElement||f instanceof HTMLCanvasElement||f instanceof Sprite||f instanceof SpriteMap||f instanceof Layer?new ImageWrapper(f,p,d,h,l):f instanceof Function?new(Function.prototype.bind.call(f,null,p,d,h,l)):null}}else this.grid[s][n]=null;this.draw=function(t,i,e){t=t||context;var s,n;{if(!i){for(s=0,n=this.grid.length;n>s;s++)for(var a=0,r=this.grid[s].length;r>a;a++){var o=this.grid[s][a];null!==o&&o.draw(t,e)}return this}var h=this.getCellsInRect();for(s=0,n=h.length;n>s;s++)h[s].draw(t,e)}},this.getCell=function(t,i){return this.grid[t]?this.grid[t][i]:void 0},this.setCell=function(t,i,e){return this.grid[t]&&this.grid[t][i]!==void 0&&(this.grid[t][i]=e),this},this.clearCell=function(t,i){return this.grid[t]&&this.grid[t][i]!==void 0&&(this.grid[t][i]=null),this},this.getAll=function(){var t=this.grid.length,i=t>0?this.grid[0].length:0,e=[],s,n;for(s=0;t>s;s++)for(n=0;i>n;n++)null!==this.grid[s][n]&&e.push(this.grid[s][n]);return e},this.clearAll=function(){var i=this.grid.length,e=i>0?this.grid[0].length:0,s,n;for(this.grid=Array(i),s=0;i>s;s++)for(this.grid[s]=Array(e),n=0;e>n;n++)t[s][n]=null;return this},this.getRows=function(){return this.grid.length},this.getCols=function(){return this.grid.length>0?this.grid[0].length:0},this.forEach=function(t,i){var e=this.grid.length,s=e>0?this.grid[0].length:0,n,a;for(n=0;e>n;n++)for(a=0;s>a;a++)(null!==this.grid[n][a]||i)&&t(this.grid[n][a],n,a)&&(this.grid[n][a].destroy instanceof Function&&this.grid[n][a].destroy(),this.clearCell(n,a));return this},this._getCellCoordsInRect=function(t,i,e,s){t===void 0&&(t=world.xOffset),i===void 0&&(i=world.yOffset),e===void 0&&(e=canvas.width),s===void 0&&(s=canvas.height);var n=this.options.startCoords[0],a=this.options.startCoords[1],r=this.options.cellSize[0],o=this.options.cellSize[1],h=(t-n)/r,l=(i-a)/o,c=(t+e-n)/r,u=(a-i+s)/o;return[Math.floor(h),Math.floor(l),Math.ceil(c),Math.ceil(u)]},this.getCellsInRect=function(t,i,e,s){for(var n=this._getCellCoordsInRect(t,i,e,s),a=[],r=Math.min(this.getRows(),Math.max(0,n[1])),o=Math.min(this.getRows(),Math.max(0,n[3])),h=Math.min(this.getCols(),Math.max(0,n[0])),l=Math.min(this.getCols(),Math.max(0,n[2])),c=r,u=o;u>c;c++)for(var f=h,p=l;p>f;f++)null!==this.grid[c][f]&&a.push(this.grid[c][f]);return a}}function World(t,i){this.scale=1,this.width=t||parseInt($canvas.attr("data-worldwidth"),10)||canvas.width,this.height=i||parseInt($canvas.attr("data-worldheight"),10)||canvas.height,this.xOffset=(this.width-canvas.width)/2,this.yOffset=(this.height-canvas.height)/2,context.translate(-this.xOffset,-this.yOffset),this.getOffsets=function(){return{x:this.xOffset,y:this.yOffset}},this.resize=function(t,i){var e=(t-this.width)/2,s=(i-this.height)/2;this.xOffset+=e,this.yOffset+=s,context.translate(-e,-s),this.width=t,this.height=i,jQuery(document).trigger("resizeWorld",[e,s,this])},this.scaleResolution=function(t,i,e){$canvas.css({width:canvas.width/this.scale+"px",height:canvas.height/this.scale+"px"}),canvas.width=0|canvas.width*t,canvas.height=0|canvas.height*t,i=i||0,e=e||0,this.xOffset=0|Math.min(this.width-canvas.width,Math.max(0,i-canvas.width/2)),this.yOffset=0|Math.min(this.height-canvas.height,Math.max(0,e-canvas.height/2)),context.translate(-this.xOffset,-this.yOffset),this.scale=t,isAnimating()||draw()},this.centerViewportAround=function(t,i){var e=0|Math.min(this.width-canvas.width,Math.max(0,t-canvas.width/2)),s=0|Math.min(this.height-canvas.height,Math.max(0,i-canvas.height/2)),n=this.xOffset-e,a=this.yOffset-s;this.xOffset=e,this.yOffset=s,context.translate(n,a)},this.isInView=function(t,i){return i?t.x+t.width>this.xOffset&&t.x<this.xOffset+canvas.width&&t.y+t.height>this.yOffset&&t.y<this.yOffset+canvas.height:t.x>this.xOffset&&t.x+t.width<this.xOffset+canvas.width&&t.y>this.yOffset&&t.y+t.height<this.yOffset+canvas.height},this.isInWorld=function(t,i){return i?t.x+t.width>=0&&t.x<=world.width&&t.y+t.height>=0&&t.y<=world.height:t.x>=0&&t.x+t.width<=world.width&&t.y>=0&&t.y+t.height<=world.height}}function Layer(t){t=t||{},this.canvas=t.canvas||document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.context.__layer=this,this.width=t.width||world.width||canvas.width,this.height=t.height||world.height||canvas.height,this.x=t.x||0,this.y=t.y||0,this.relative=t.relative||"world",this.opacity=t.opacity||1,this.parallax=t.parallax||1,this.canvas.width=this.width,this.canvas.height=this.height,this.xOffset=0,this.yOffset=0,t.src&&this.context.drawImage(t.src,0,0,this.width,this.height),this.draw=function(t,i,e){return t instanceof CanvasRenderingContext2D||(e=i,i=t,t=context),i=i===void 0?this.x:i,e=e===void 0?this.y:e,t.save(),t.globalAlpha=this.opacity,"canvas"==this.relative&&t.translate(world.xOffset,world.yOffset),(this.xOffset||this.yOffset)&&t.translate(this.xOffset,this.yOffset),t.drawImage(this.canvas,i,e),t.restore(),this},this.clear=function(t){return this.context.clear(t),this},this.scroll=function(t,i,e){return e=e||this.parallax,this.xOffset+=-t*e,this.yOffset+=-i*e,this},this.showCanvasOverlay=function(){stopAnimating();var t=jQuery("<div></div>");t.css({cursor:"pointer",display:"block",height:"100%",left:0,position:"absolute",top:0,width:"100%"});var i=jQuery(this.canvas);return i.css({border:"1px solid black",display:"block",margin:"0 auto",position:"absolute","z-index":100}).click(function(){t.remove(),startAnimating()}),t.append(i),jQuery("body").append(t),t.click(function(i){3!=i.which&&t.remove()}),t}}(function(t){function i(i){if("string"==typeof i.data){var e=i.handler,s=i.data.toLowerCase().split(" ");i.handler=function(i){if(this===i.target||!(/textarea|select/i.test(i.target.nodeName)||t.inArray(i.target.type,t.hotkeys.textTypes)>-1)){var n="keypress"!==i.type&&t.hotkeys.specialKeys[i.which],a=String.fromCharCode(i.which).toLowerCase(),r,o="",h={};i.altKey&&"alt"!==n&&(o+="alt+"),i.ctrlKey&&"ctrl"!==n&&(o+="ctrl+"),i.metaKey&&!i.ctrlKey&&"meta"!==n&&(o+="meta+"),i.shiftKey&&"shift"!==n&&(o+="shift+"),n?h[o+n]=!0:(h[o+a]=!0,h[o+t.hotkeys.shiftNums[a]]=!0,"shift+"===o&&(h[t.hotkeys.shiftNums[a]]=!0));var c,u;for("keydown"===i.type?(u=n||a,c=t.inArray(u,t.hotkeys.keysDown),(void 0===c||0>c)&&t.hotkeys.keysDown.push(u)):"keyup"===i.type&&(u=n||a,c=t.inArray(u,t.hotkeys.keysDown),void 0!==c&&c>-1&&t.hotkeys.keysDown.splice(c,1),t.hotkeys.lastKeysPressed.push(u),t.hotkeys.lastKeysPressed.length>5&&t.hotkeys.lastKeysPressed.shift()),c=0,l=s.length;l>c;c++)if(h[s[c]])return i.keyPressed=s[c],e.apply(this,arguments)}}}}t.hotkeys={version:"0.9",keysDown:[],lastKeysPressed:[],textTypes:["text","search","tel","url","email","password","number","range","date","month","week","time","datetime","datetime-local","color"],specialKeys:{8:"backspace",9:"tab",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",186:";",187:"=",188:",",189:"-",190:".",191:"/",219:"[",220:"\\",221:"]",222:"'",224:"meta"},shiftNums:{"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":":","'":'"',",":"<",".":">","/":"?","\\":"|","[":"{","]":"}"},areKeysDown:function(i){var e;if("string"==typeof i){var s=i.split(" ");for(e=0;s.length>e;e++)if(this.areKeysDown(s[e].split("+")))return!0;return!1}var n=!1,a=this.keysDown.length;if(a!=i.length)return!1;for(e=0;a>e;e++)if(t.inArray(this.keysDown[e],["alt","ctrl","meta","shift"])>-1){n=!0;break}if(n){for(e=0;a>e;e++)if(-1==t.inArray(this.keysDown[e],i))return!1}else for(e=0;a>e;e++)if(this.keysDown[e]!=i[e])return!1;return!0},lastKeyPressed:function(){return this.lastKeysPressed[this.lastKeysPressed.length-1]}},t.each(["keydown","keyup","keypress"],function(){t.event.special[this]={add:i}}),t(document).keydown("na",function(){}),t(document).keyup("na",function(){})})(jQuery),function(){var t=!1,i=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){},Class.extend=function(e){function s(){!t&&this.init&&this.init.apply(this,arguments)}var n=this.prototype;t=!0;var a=new this;t=!1;for(var r in e)a[r]="function"==typeof e[r]&&"function"==typeof n[r]&&i.test(e[r])?function(t,i){return function(){var e=this._super;this._super=n[t];var s=i.apply(this,arguments);return this._super=e,s}}(r,e[r]):e[r];return s.prototype=a,s.prototype.constructor=s,s.extend=arguments.callee,s}}(),function(t){function i(t,i,e){this.sprite=new Sprite(t,e),this.baseImage=this.sprite.image,this.cachedImages={"00":this.baseImage},this.sprite.spriteMap=this,this.maps={};for(var s in i)i.hasOwnProperty(s)&&this.set(s,i[s])}i.prototype={set:function(i,e){e instanceof Array&&(e={startRow:e[0],startCol:e[1],endRow:e[2],endCol:e[3],squeeze:e[4],flipped:e[5]}),this.maps[i]={startRow:e.startRow!==t?e.startRow:0,startCol:e.startCol!==t?e.startCol:0,endRow:e.endRow!==t?e.endRow:this.sprite.rows-1,endCol:e.endCol!==t?e.endCol:this.sprite.cols-1,squeeze:e.squeeze!==t?e.squeeze:!1,flipped:e.flipped!==t?e.flipped:{horizontal:!1,vertical:!1}};var s=this.maps[i].flipped,n=(s.horizontal?"1":"0")+(s.vertical?"1":"0");return this.cachedImages[n]===t&&(this.cachedImages[n]=this.sprite._prerender(this.baseImage,s)),this.maps[i].image=this.cachedImages[n],this},unset:function(t){return this.maps.hasOwnProperty(t)&&delete this.maps[t],this},use:function(t,i){if(this.activeLoop==t&&!i)return this;this.activeLoop=t;var e=this.maps[t];return this.sprite.setLoop(e.startRow,e.startCol,e.endRow,e.endCol,e.squeeze,e.flipped),e.image&&(this.sprite.image=e.image),this},start:function(t){return t&&this.use(t),this.sprite.startLoop(),this},stop:function(){return this.sprite.stop(),this},reset:function(){return this.sprite.reset(),this},runOnce:function(t,i){return i&&this.use(i),this.sprite.runLoop(t),this},draw:function(t,i,e,s,n){return this.sprite.draw(t,i,e,s,n),this},clone:function(){return new i(this.sprite.sourceFile,this.maps,this.sprite)}},this.SpriteMap=i}.call(this),function(t){function i(t,e){if("string"==typeof t){this.sourceFile=t;var s=i.getImageFromCache(t);if(s)this._init(s,e);else{var n=new Image,a=this;n.onload=function(){a._init(this,e)},n._src=t,n.src=t,i.saveImageToCache(t,n)}}else if(t instanceof HTMLImageElement||t instanceof Image){if(!t.src)return;if(this.sourceFile=t._src||t.src,t.complete||t.width&&t.height)i.saveImageToCache(this.sourceFile,t),this._init(t,e);else{if(t._src)return;var r=t.onload,a=this;t.onload=function(){"function"==typeof r&&r(),i.saveImageToCache(a.sourceFile,t),a._init(this,e)}}}else t instanceof HTMLCanvasElement&&this._init(t,e)}i.prototype={_init:function(i,e){this.image=i,this.width=i.width,this.height=i.height,this.frameW=e.frameW||i.width,this.frameH=e.frameH||i.height,this.projectedW=e.projectedW||this.frameW,this.projectedH=e.projectedH||this.frameH,this.rows=Math.floor(this.height/this.frameH),this.cols=Math.floor(this.width/this.frameW),this.startRow=e.startRow||0,this.startCol=e.startCol||0,this.endRow=e.endRow===t?this.rows-1:e.endRow,this.endCol=e.endCol===t?this.cols-1:e.endCol,this.row=this.startRow,this.col=this.startCol,this.frame=1,this.squeeze=e.squeeze||!1,this.interval=e.interval===t?125:e.interval,this.useTimer=e.useTimer===t?!0:e.useTimer,this.advanceFramesManually=e.advanceFramesManually||!1,this.lastFrameUpdateTime=0,this.flipped=e.flipped||{horizontal:!1,vertical:!1},this.flipped.horizontal=this.flipped.horizontal||!1,this.flipped.vertical=this.flipped.vertical||!1,this._runOnce=!1,this.squeeze&&(this.cols=this.endCol-this.startCol+1),this.numFrames=this.getNumFrames(),e.postInitCallback&&e.postInitCallback(this)},_prerender:function(t,i){var e=document.createElement("canvas");e.width=this.width,e.height=this.height;var s=e.getContext("2d");return(i.horizontal||i.vertical)&&(s.translate(i.horizontal?e.width:0,i.vertical?e.height:0),s.scale(i.horizontal?-1:1,i.vertical?-1:1)),s.drawImage(t,0,0),e},draw:function(t,i,e,s,n){try{t.save(),s=s||this.projectedW,n=n||this.projectedH;var a=this.col*this.frameW,r=this.row*this.frameH;this.flipped.horizontal&&(a=this.width-a-this.frameW),this.flipped.vertical&&(r=this.height-r-this.frameH),t.drawImage(this.image,a,r,this.frameW,this.frameH,i,e,s,n),t.restore()}catch(o){console&&console.error&&console.error(o)}return!this.useTimer&&!this.advanceFramesManually&&Date.now()-this.lastFrameUpdateTime>this.interval&&this.nextFrame(),this},reset:function(){return this.row=this.startRow,this.col=this.startCol,this.frame=1,this.lastFrameUpdateTime=0,this},changeFrame:function(t){return this.frame+=t,this.setFrame(this.frame),this},setFrame:function(i,e){if(e!==t)this.row=i,this.col=e,this.frame=this.squeeze?this.cols*(this.row-this.startRow+1)-(this.endCol-this.col):this.cols*(this.row-this.startRow+1)-(this.cols-(this.col+1))-this.startCol;else{var s=this.frameNumberToRowCol(i);this.frame=s.frame,this.row=s.row,this.col=s.col}return this.lastFrameUpdateTime=Date.now(),this},setLoop:function(i,e,s,n,a,r){return this.stopLoop(),(null===s||s===t)&&(s=this.rows-1),(null===n||n===t)&&(n=this.cols-1),a!==t&&(this.squeeze=a),r!==t&&(this.flipped=r),this.startRow=i,this.startCol=e,this.endRow=s,this.endCol=n,this.reset(),this.numFrames=this.getNumFrames(),this},startLoop:function(i,e,s,n,a,r){if(i!==t&&e!==t&&this.setLoop(i,e,s,n,a,r),this.lastFrameUpdateTime=Date.now(),this.interval&&this.useTimer){var o=this;this.intervalID=setInterval(function(){o.nextFrame()},this.interval)}return this},stopLoop:function(){return this.lastFrameUpdateTime=0,this.intervalID&&clearInterval(this.intervalID),this},runLoop:function(t,i,e,s,n,a,r){return this.runLoopCallback=t||function(){},this._runOnce=!0,Array.prototype.shift.call(arguments),this.startLoop.apply(this,arguments),this},prevFrame:function(){return changeFrame(-1),this},nextFrame:function(){return this.col++,this.frame++,this.row==this.endRow&&this.col>this.endCol?this._runOnce?(this.stopLoop(),this._runOnce=!1,this.runLoopCallback(this)):this.reset():this.squeeze&&this.col>this.endCol?(this.col=this.startCol,this.row++):!this.squeeze&&this.col>=this.cols&&(this.col=0,this.row++),this.lastFrameUpdateTime=Date.now(),this},getFrame:function(){return{row:this.row,col:this.col,frame:this.frame}},getNumFrames:function(){return this.squeeze?(this.endRow-this.startRow+1)*(this.endCol-this.startCol+1):(this.endRow-this.startRow)*this.cols-this.startCol+this.endCol+1},frameNumberToRowCol:function(t){var i,e;return t=(t+this.numFrames)%this.numFrames||this.numFrames,this.squeeze?(i=this.startRow+Math.floor((t-1)/this.cols),e=(t-1)%this.cols+this.startCol):(i=this.startRow+Math.floor((t+this.startCol-1)/this.cols),e=(t+this.startCol-1)%this.cols),{frame:t,row:i,col:e}},clone:function(){return new i(this.sourceFile,this)}},this.Sprite=i}.call(this),function(){var t={};Sprite.getImageFromCache=function(i){return t[i]?t[i]:null},Sprite.saveImageToCache=function(i,e){t[i]=e},Sprite.preloadImages=function(t,i){var e=t.length,s=-1,n,a,r=function(t,n){s++,"function"==typeof t&&t(n,s,e),s==e&&"function"==typeof i.finishCallback&&i.finishCallback(e)};r();for(var o=function(){Sprite.saveImageToCache(this._src,this),r(i.itemCallback,this._src)};t.length;)n=t.pop(),a=new Image,a._num=e-t.length,a._src=n,a.onload=o,a.src=n}}.call(this);var App={};App.isGameOver=!1,App.debugMode=!1,App.MIN_FPS=4,App.MAX_FPS=100,App.physicsTimeElapsed=0,App.physicsDelta=0,App.isSomethingBeingDragged=!1,App.Debug={},App.Debug.updateTimeElapsed=0,App.Debug.clearTimeElapsed=0,App.Debug.drawTimeElapsed=0;var canvas,$canvas,context,world,Mouse={coords:{x:9999,y:9999}};jQuery(document).ready(function(){canvas=document.getElementById("canvas"),$canvas=jQuery(canvas),App.setDefaultCanvasSize(),context=canvas.getContext("2d"),"undefined"!=typeof Stats&&App.debugMode&&(App.stats=new Stats,App.stats.setMode(0),App.stats.domElement.style.position="absolute",App.stats.domElement.style.left=$canvas.offset().left,App.stats.domElement.style.top=$canvas.offset().top,document.body.appendChild(App.stats.domElement)),$canvas.hover(function(){var t=jQuery(this);t.on("mousemove.coords, touchmove.coords",function(i){"touchmove"==i.type&&i.preventDefault(),Mouse.coords={x:i.pageX-t.offset().left,y:i.pageY-t.offset().top}})},function(){jQuery(this).off(".coords"),Mouse.coords={x:-9999,y:-9999}}),$canvas.on("mousedown mouseup click touchstart touchend",function(t){isAnimating()&&App.Events.trigger(t.type,t)}),$canvas.on("mouseup.drag touchend.drag",function(t){App.Events.trigger("canvasdragstop",t),App.isSomethingBeingDragged=!1,jQuery(document).trigger("canvasdragstop")}),jQuery(document).on("canvasdrop",function(t,i){App.Events.trigger("canvasdrop",t,i)})}),jQuery(window).load(function(){if("undefined"!=typeof keys)for(var t in keys)keys.hasOwnProperty(t)&&App.preventDefaultKeyEvents(keys[t].join(" "));Caches.preloadImages("undefined"==typeof preloadables?[]:preloadables,{finishCallback:function(){"undefined"==typeof Events&&(Events=App.Events),"undefined"==typeof Utils&&(Utils=App.Utils),App.reset(!0)}})}),App.reset=function(t){stopAnimating(),App.isSomethingBeingDragged&&(App.isSomethingBeingDragged=!1,jQuery(document).trigger("canvasdragstop")),world!==void 0&&(context.translate(world.xOffset,world.yOffset),world.scaleResolution(1/world.scale)),world=new World,context.__layer=world,App.timer=new Timer(!1),App.timer.frames=0,App.isGameOver=!1,App.physicsTimeElapsed=0,App.Debug.updateTimeElapsed=0,App.Debug.clearTimeElapsed=0,App.Debug.drawTimeElapsed=0;var i=setup(!!t);Timer.event("app start"),i!==!1&&startAnimating(),jQuery(document).trigger("start",[!!t])},App.setDefaultCanvasSize=function(){if("false"!=$canvas.attr("data-resize")){var t=jQuery(window);if("full"==$canvas.attr("data-resize"))canvas.width=t.innerWidth()-parseInt($canvas.css("border-left-width"),10)-parseInt($canvas.css("border-right-width"),10)-1,canvas.height=t.innerHeight()-parseInt($canvas.css("border-top-width"),10)-parseInt($canvas.css("border-bottom-width"),10)-1;else{var i=$canvas.attr("data-maxwidth")||canvas.width,e=$canvas.attr("data-minwidth")||canvas.width;canvas.width=Math.min(i,Math.max(t.width(),e));var s=$canvas.attr("data-maxheight")||canvas.height,n=$canvas.attr("data-minheight")||canvas.height;canvas.height=Math.min(s,Math.max(t.height(),n))}var a=$canvas.attr("data-aspectratio")||0;a&&(-1==a.indexOf(":")?a=parseFloat(a):"4:3"==a?a=4/3:"16:9"==a?a=16/9:("16:10"==a||"8:5"==a)&&(a=1.6),canvas.width<canvas.height*a?canvas.height=Math.floor(canvas.width/a):canvas.width>canvas.height*a&&(canvas.width=Math.floor(canvas.height*a)))}};var Caches={images:{},imagePatterns:{},preloadImages:function(t,i){var e=t.length,s=-1,n,a,r=function(t,n){s++,"function"==typeof t&&t(n,s,e),s==e&&"function"==typeof i.finishCallback&&i.finishCallback(e)};r();for(var o=function(){Caches.images[this._src]=this,r(i.itemCallback,this._src)};t.length;)n=t.pop(),a=new Image,a._num=e-t.length,a._src=n,a.onload=o,a.src=n}};Sprite&&(Sprite.getImageFromCache=function(t){return Caches.images[t]},Sprite.saveImageToCache=function(t,i){Caches.images[t]=i},Sprite.preloadImages=Caches.preloadImages),function(){function t(){return App.isHovered(this)}var i={};App.Events={listen:function(t,e,s,n){var a=arguments[4],r=e.split(" ");if(!(r.length>1)){var o="",h=e.indexOf(".");return-1!==h&&(o=e.substring(h+1),e=e.substring(0,h)),i[e]||(i[e]=[]),i[e].push({object:t,callback:function(){s.apply(t,arguments)},namespace:o,weight:n||0,once:a||!1}),t}for(var l=0,c=r.length;c>l;l++)App.Events.listen(t,r[l],s,n,a)},once:function(t,i,e,s){return App.Events.listen(t,i,e,s,!0)},unlisten:function(t,e){var s=e.split(" ");{if(!(s.length>1)){var n="",a=e.indexOf("."),r;if(-1!==a&&(n=e.substring(a+1),e=e.substring(0,a)),e&&i[e])for(r=i[e],a=r.length-1;a>=0;a--)r[a].object!=t||n&&r[a].namespace!=n||i[e].splice(a,1);else if(!e&&n)for(e in i)if(i.hasOwnProperty(e))for(r=i[e],a=r.length-1;a>=0;a--)r[a].object==t&&r[a].namespace==n&&i[e].splice(a,1);return t}for(var o=0,h=s.length;h>o;o++)App.Events.unlisten(t,s[o])}},trigger:function(t){t=Array.prototype.shift.call(arguments);var e=i[t];if(e){e.sort(function(t,i){return i.weight-t.weight});for(var s=e.length-1;s>=0;s--)if(!App.Events.Behaviors[t]||App.Events.Behaviors[t].apply(e[s].object,arguments)){e[s].callback.apply(e[s].object,arguments),e[s].once&&App.Events.unlisten(e[s].object,t+"."+e[s].namespace);var n=Array.prototype.shift.call(arguments);if(n&&n.isPropagationStopped&&n.isPropagationStopped())break}}},Behaviors:{mousedown:t,mouseup:t,click:t,touchstart:t,touchend:t,canvasdragstop:function(){return!!this.isBeingDragged},canvasdrop:function(t,i){return this===i}}}}(),window.requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,1e3/60)}}(),function(){function t(){App.stats!==void 0&&App.stats.begin();var e=App.timer.getDelta();for(App.timer.running||App.timer.start(),App.MIN_FPS&&e>1/App.MIN_FPS&&(jQuery(document).trigger("low_fps",[1/e]),e=1/App.MIN_FPS),App.timer.frames++,App.debugMode&&Timer.event("debug timer update",!0),Mouse.Scroll._update();e>0&&!App.isGameOver;)App.physicsDelta=Math.min(e,1/App.MAX_FPS),update(App.physicsDelta,App.physicsTimeElapsed),e-=App.physicsDelta,App.physicsTimeElapsed+=App.physicsDelta;App.debugMode&&(App.Debug.updateTimeElapsed+=Timer.getTimeSince("debug timer update"),Timer.event("debug timer clear",!0)),context.clear(),App.debugMode&&(App.Debug.clearTimeElapsed+=Timer.getTimeSince("debug timer clear"),Timer.event("debug timer draw",!0)),draw(),App.debugMode&&(App.Debug.drawTimeElapsed+=Timer.getTimeSince("debug timer draw")),App.stats!==void 0&&App.stats.end(),i&&window.requestAnimFrame(t)}var i=!1,e=!1;window.startAnimating=function(){i||(i=!0,jQuery(document).trigger("startAnimating"),t())},window.stopAnimating=function(){if(i&&(i=!1,App.timer.stop(),jQuery(document).trigger("stopAnimating"),App.debugMode&&console&&console.log)){var t=App.physicsTimeElapsed,e=App.timer.frames,s=App.Debug,n=s.updateTimeElapsed+s.clearTimeElapsed+s.drawTimeElapsed;console.log({"ms/frame":{update:s.updateTimeElapsed/e,clear:s.clearTimeElapsed/e,draw:s.drawTimeElapsed/e,animOps:n/e,other:(t-n)/e,animate:t/e},percent:{update:100*(s.updateTimeElapsed/t),clear:100*(s.clearTimeElapsed/t),draw:100*(s.drawTimeElapsed/t),animOps:100*(n/t),other:100*((t-n)/t)},fps:e/t})}},window.isAnimating=function(){return i},jQuery(window).on("focus.animFocus",function(){e&&(e=!1,startAnimating())}),jQuery(window).on("blur.animFocus",function(){stopAnimating(),e=!0})}(),CanvasRenderingContext2D.prototype.clear=function(t){this.save();var i=0,e=0;this.__layer?(i=this.__layer.xOffset,e=this.__layer.yOffset):this.setTransform(1,0,0,1,0,0),t?(this.fillStyle=t,this.fillRect(i,e,this.canvas.width,this.canvas.height)):this.clearRect(i,e,this.canvas.width,this.canvas.height),this.restore()},CanvasRenderingContext2D.prototype.__drawImage=CanvasRenderingContext2D.prototype.drawImage,CanvasRenderingContext2D.prototype.drawImage=function(t,i,e,s,n,a,r,o,h,l){0===arguments.length%2&&(l=Array.prototype.pop.call(arguments),s instanceof Function?s=void 0:a instanceof Function?a=void 0:o instanceof Function&&(o=void 0),"function"!=typeof l&&(l=void 0));var c=this,u=arguments;"number"!=typeof a&&r===void 0&&"number"!=typeof o&&h===void 0&&(a=i,r=e,"number"==typeof s&&n!==void 0&&(o=s,h=n),i=void 0,e=void 0,s=void 0,n=void 0);var f=function(t,i,e,s,n,a,r,o,h){s&&n?o&&h?c.__drawImage(t,a,r,o,h,i,e,s,n):c.__drawImage(t,i,e,s,n):c.__drawImage(t,i,e),l instanceof Function&&l.call(c,u,!0)};if("undefined"!=typeof Sprite&&t instanceof Sprite||"undefined"!=typeof SpriteMap&&t instanceof SpriteMap)t.draw(this,a,r,o,h),l instanceof Function&&l.call(c,u,!0);else if(t instanceof Layer){c.save(),c.globalAlpha=t.opacity,"canvas"==t.relative&&c.translate(world.xOffset,world.yOffset);var p=l;l=void 0,f(t.canvas,a,r,o,h,i,e,s,n),c.restore(),l=p,l instanceof Function&&l.call(c,u,!0)}else if(t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement)f(t,a,r,o,h,i,e,s,n);else if(t instanceof HTMLImageElement||t instanceof Image){var d=t;if(t=d._src||d.src,!t)return l instanceof Function&&l.call(c,u,!1),void 0;if(Caches.images[t]||(Caches.images[t]=d),d.complete||d.width&&d.height)f(d,a,r,o,h,i,e,s,n);else{if(d._src)return;var g=d.onload;d.onload=function(){"function"==typeof g&&g(),l instanceof Function&&l.call(c,u,!1)}}}else if("string"==typeof t&&Caches.images[t]){var d=Caches.images[t];(d.complete||d.width&&d.height)&&f(d,a,r,o,h,i,e,s,n)}else{if("string"!=typeof t)throw new TypeMismatchError("Image type not recognized.");var d=new Image;d.onload=function(){l instanceof Function&&l.call(c,u,!1)},d._src=t,d.src=t,Caches.images[t]=d}},CanvasRenderingContext2D.prototype.drawPattern=function(t,i,e,s,n,a,r){if(i===void 0&&(i=0),e===void 0&&(e=0),s===void 0&&(s=this.canvas.width),n===void 0&&(n=this.canvas.height),"function"==typeof a?(r=a,a="repeat"):a||(a="repeat"),t instanceof Layer&&(t=t.canvas),t instanceof CanvasPattern)this.fillStyle=t,this.fillRect(i,e,s,n),r instanceof Function&&r.call(this,arguments,!0);else if(t instanceof Layer)this.save(),this.globalAlpha=t.opacity,"canvas"==t.relative&&this.translate(world.xOffset,world.yOffset),this.fillStyle=this.createPattern(t.canvas,a),this.fillRect(i,e,s,n),this.restore(),r instanceof Function&&r.call(this,arguments,!0);else if(t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement)this.fillStyle=this.createPattern(t,a),this.fillRect(i,e,s,n),r instanceof Function&&r.call(this,arguments,!0);else if(t instanceof HTMLImageElement||t instanceof Image){var o=t;if(t=o._src||o.src,!t)return r instanceof Function&&r.call(this,arguments,!1),void 0;if(Caches.imagePatterns[t])return this.fillStyle=Caches.imagePatterns[t],this.fillRect(i,e,s,n),r instanceof Function&&r.call(this,arguments,!0),this.fillStyle;if(Caches.images[t]||(Caches.images[t]=o),o.complete||o.width&&o.height)this.fillStyle=this.createPattern(o,a),this.fillRect(i,e,s,n),Caches.imagePatterns[t]=this.fillStyle,r instanceof Function&&r.call(this,arguments,!0);else{if(o._src)return;var h=this,l=o.onload;o.onload=function(){"function"==typeof l&&l(),Caches.imagePatterns[t]=this.createPattern(o,a),r instanceof Function&&r.call(h,arguments,!1)}}}else if("string"==typeof t)if(Caches.imagePatterns[t])this.fillStyle=Caches.imagePatterns[t],this.fillRect(i,e,s,n),r instanceof Function&&r.call(this,arguments,!0);else if(Caches.images[t]){var o=Caches.images[t];(o.complete||o.width&&o.height)&&(this.fillStyle=this.createPattern(o,a),this.fillRect(i,e,s,n),Caches.imagePatterns[t]=this.fillStyle,r instanceof Function&&r.call(this,arguments,!0))}else{var o=new Image,h=this;o.onload=function(){Caches.imagePatterns[t]=this.createPattern(o,a),r instanceof Function&&r.call(h,arguments,!1)},o._src=t,o.src=t,Caches.images[t]=o}return Caches.imagePatterns[t]?Caches.imagePatterns[t]:void 0},CanvasRenderingContext2D.prototype.drawCheckered=function(t,i,e,s,n,a,r){if(t===void 0&&(t=80),"string"==typeof t&&"string"==typeof i){var o=t,h=i;t=e,i=s,e=n,s=a,n=r,a=o,r=h}var l=document.createElement("canvas"),c=l.getContext("2d");return l.width=2*t,l.height=2*t,c.fillStyle=a||"silver",c.fillRect(0,0,t,t),c.fillRect(t,t,t,t),c.fillStyle=r||"lightGray",c.fillRect(t,0,t,t),c.fillRect(0,t,t,t),this.drawPattern(l,i||0,e||0,s||this.canvas.width,n||this.canvas.height)},CanvasRenderingContext2D.prototype.circle=function(t,i,e,s,n){this.beginPath(),this.arc(t,i,e,0,2*Math.PI,!1),null!==s&&(s&&(this.fillStyle=s),this.fill()),void 0!==n&&(this.lineWidth=Math.max(Math.ceil(e/15),1),n&&(this.strokeStyle=n),this.stroke())},CanvasRenderingContext2D.prototype.drawSmiley=function(t,i,e,s){var n=Math.max(Math.ceil(e/15),1);this.circle(t,i,e,s||"lightBlue","black"),this.beginPath(),this.arc(t,i,.6*e,.1*Math.PI,.9*Math.PI,!1),this.lineWidth=n,this.strokeStyle="black",this.stroke(),this.beginPath(),this.arc(t-.3*e,i-.25*e,Math.max(Math.ceil(e/15),1),0,2*Math.PI,!1),this.fillStyle="black",this.fill(),this.arc(t+.3*e,i-.25*e,Math.max(Math.ceil(e/15),1),0,2*Math.PI,!1),this.fillStyle="black",this.fill()},CanvasRenderingContext2D.prototype.drawBkgdRadialGradient=function(){var t=context.createRadialGradient(world.width/2,world.height/2,50,world.width/2,world.height/2,world.width/2);t.addColorStop(0,"#A7D30C"),t.addColorStop(.6,"#067A9E"),t.addColorStop(1,"rgba(1,159,98,0)"),this.clear(t)},App.preventDefaultKeyEvents=function(t){jQuery(document).keydown(t,function(){return!1})},App.isHovered=function(t){var i=world.getOffsets(),e=t.x-i.x,s=t.y-i.y;return Mouse.coords.x>e&&Mouse.coords.x<e+t.width&&Mouse.coords.y>s&&Mouse.coords.y<s+t.height},Mouse.Scroll=function(){function t(t){var a=!1,r;return void 0===t&&(t=!0),Mouse.coords.x<canvas.width*i?(t&&(r=Math.round(Math.min(world.xOffset,e*App.physicsDelta)),world.xOffset-=r,n.x-=r,context.translate(r,0)),a=!0):Mouse.coords.x>canvas.width*(1-i)&&(t&&(r=Math.round(Math.min(world.width-canvas.width-world.xOffset,e*App.physicsDelta)),world.xOffset+=r,n.x+=r,context.translate(-r,0)),a=!0),Mouse.coords.y<canvas.height*i?(t&&(r=Math.round(Math.min(world.yOffset,e*App.physicsDelta)),world.yOffset-=r,n.y-=r,context.translate(0,r)),a=!0):Mouse.coords.y>canvas.height*(1-i)&&(t&&(r=Math.round(Math.min(world.height-canvas.height-world.yOffset,e*App.physicsDelta)),world.yOffset+=r,n.y+=r,context.translate(0,-r)),a=!0),t&&0===n.x&&0===n.y&&(a=!1),t&&s!=a&&(s?jQuery(document).trigger("mousescrollon"):jQuery(document).trigger("mousescrolloff")),s=a,n}var i=.2,e=350,s=!1,n={x:0,y:0},a=!1;return{enable:function(){a||(a=!0,$canvas.on("mouseenter.translate touchstart.translate",function(){jQuery(this).on("mousemove.translate",function(){t(!1)
})}),$canvas.on("mouseleave.translate touchleave.translate",function(){s=!1,jQuery(this).off(".translate")}))},disable:function(){$canvas.off(".translate"),s=!1,a=!1},isEnabled:function(){return a},isScrolling:function(){return s},_update:function(){return s?t():void 0},setThreshold:function(t){i=t},getThreshold:function(){return i},setScrollDistance:function(t){e=t},getScrollDistance:function(){return e}}}(),window.performance=window.performance||{},performance.now=function(){return performance.now||performance.mozNow||performance.msNow||performance.oNow||performance.webkitNow||function(){return Date.now()}}(),function(){var t={},i=0;Timer.event=function(e,s){var n={whileAnimating:s,startTime:s?App.physicsTimeElapsed:performance.now()};e===void 0?i=n:t[e]=n},Timer.getTimeSince=function(e){var s=t[e]===void 0?i:t[e],n=s.whileAnimating?App.physicsTimeElapsed:performance.now();return s.startTime?(n-s.startTime)/1e3:0}}(),App.Utils={},App.Utils.percentToPixels=function(t,i){return i===void 0&&(i=!0),{x:Math.floor((i?canvas:world).width*t/100),y:Math.floor((i?canvas:world).height*t/100)}},App.Utils.getRandBetween=function(t,i){if(t>i){var e=t;t=i,i=e}return Math.random()*(i-t)+t},App.Utils.getRandIntBetween=function(t,i){if(t>i){var e=t;t=i,i=e}return t=Math.ceil(t),i=Math.floor(i),Math.floor(Math.random()*(i-t+1)+t)},App.Utils.anyIn=function(t,i){for(var e=0,s=t.length;s>e;e++)if(-1!=i.indexOf(t[e]))return!0;return!1},App.Utils.almostEqual=function(t,i,e){return t>=i-e&&i+e>=t},App.Utils.randomString=function(t){var i="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789-_",e="";t=t||32;for(var s=0;t>s;s++)e+=i.charAt(Math.floor(Math.random()*i.length));return e},App.Utils.positionOverCanvas=function(t,i,e){var s=$canvas.offset();jQuery(t).css({left:s.left+parseInt($canvas.css("border-left-width"),10)+i+"px",position:"absolute",top:s.top+parseInt($canvas.css("border-top-width"),10)+e+"px","z-index":100})},App.gameOver=function(){App.isGameOver||(App.isGameOver=!0,stopAnimating(),player&&player.destroy(),setTimeout(function(){context.save(),context.font="100px Arial",context.fillStyle="black",context.strokeStyle="lightGray",context.textBaseline="middle",context.textAlign="center",context.shadowColor="black",context.shadowBlur=8,context.lineWidth=5;var t=Math.round(world.xOffset+canvas.width/2),i=Math.round(world.yOffset+canvas.height/2);context.strokeText("GAME OVER",t,i),context.fillText("GAME OVER",t,i),context.restore()},100),$canvas.css("cursor","pointer"),$canvas.one("click.gameover",function(t){t.preventDefault(),$canvas.css("cursor","auto"),App.reset()}))},Array.prototype.remove=function(t){var i=this.indexOf(t);return void 0===i||0>i?void 0:this.splice(i,1)},Number.prototype.round=function(t,i){i===void 0&&(i=t,t=this),i||(i=0);var e=Math.pow(10,0|i);return Math.round(t*e)/e},Number.prototype.sign=function(t){return t===void 0&&(t=this),t>0?1:0>t?-1:0},function(t){function i(){var t=Error().stack;if(t){var i=t.split(/\n/g),e=2,s=!1,n=0;for(var a in i){if(n==e)return i[a];!s&&i[a].match(/getCallID/)&&(s=!0),s&&n++}}return"exception"}t.throttle=function(){if(2>arguments.length)return t;var e=0,s=i(),n=Array.prototype.pop.call(arguments);"number"==typeof n?(e=n,n=t.log||function(){}):"function"==typeof n&&(e=Array.prototype.pop.call(arguments)),this.lastLogged===void 0&&(this.lastLogged={}),this.lastLogged[s]===void 0&&(this.lastLogged[s]=0);var a=performance.now();return a>this.lastLogged[s]+e&&(this.lastLogged[s]=a,n.apply(n,arguments)),t}}(console),App.Storage=function(t,i){var e={enabled:!0},s="__appstore__",n=t.localStorage,a={},r=!1;e.set=function(t,a){return t=s+t,a===i?e.remove(t):(n.setItem(t,JSON.stringify(a)),i)},e.get=function(t,i){t=s+t;try{var e=n.getItem(t);if("string"==typeof e)return JSON.parse(e);if(null!==e)return e}catch(a){console&&console.error&&console.error(a)}return i},e.remove=function(t){n.removeItem(s+t)},e.clear=function(){n.clear()},e.length=function(){return r?a.length:n.length},e.key=function(t){return n.key(t)},e.isEnabled=function(){return e.enabled};try{e.set(s,s),e.get(s)!=s&&(e.enabled=!1),e.remove(s)}catch(o){e.enabled=!1}return e.enabled||(n={setItem:function(t,i){a[t]=i},getItem:function(t){return a[t]},removeItem:function(t){delete a[t]},clear:function(){a={}},key:function(t){var i=0;for(var e in a)if(a.hasOwnProperty(e)){if(i==t)return a[e];i++}}}),e}(window);var Box=Class.extend({init:function(t,i,e,s,n){this.x=t||Math.floor((world.width-this.DEFAULT_WIDTH)/2),this.y=i||Math.floor((world.height-this.DEFAULT_HEIGHT)/2),this.width=e||this.DEFAULT_WIDTH,this.height=s||this.DEFAULT_HEIGHT,this.fillStyle=n||"black",this.draw()},DEFAULT_WIDTH:80,DEFAULT_HEIGHT:80,src:null,radians:0,draw:function(t,i){t=t||context,i===void 0&&(i=!0),t.save(),t.fillStyle=this.fillStyle;var e=this.x,s=this.y,n=this.width,a=this.height;i&&(e=Math.round(e),s=Math.round(s)),this.radians&&(t.translate(e+n/2,s+a/2),t.rotate(this.radians),t.translate(-n/2-e,-a/2-s)),this.src?t.drawImage(this.src,e,s,n,a):this.drawDefault(t,e,s,n,a),t.restore()},drawDefault:function(t,i,e,s,n){t.fillRect(i,e,s,n)},drawBoundingBox:function(t,i){t=t||context,i&&(t.strokeStyle=i),t.strokeRect(this.x,this.y,this.width,this.height)},xC:function(){return this.x+this.width/2},yC:function(){return this.y+this.height/2},collides:function(t,i,e){if(t instanceof Box&&(t!==this||!e))return this.overlaps(t)?t:!1;if(t instanceof Collection||t instanceof TileMap){for(var s=t.getAll(),n=[],a=0,r=s.length;r>a;a++)if(this.overlaps(s[a])&&(s[a]!==this||!e)){if(!i)return s[a];n.push(s[a])}if(n.length)return n}return!1},overlaps:function(t){return this.overlapsX(t)&&this.overlapsY(t)},overlapsX:function(t){return this.x+this.width>=t.x&&t.x+t.width>=this.x},overlapsY:function(t){return this.y+this.height>=t.y&&t.y+t.height>=this.y},isHovered:function(){return App.isHovered(this)},listen:function(t,i,e){return App.Events.listen(this,t,i,e),this},once:function(t,i,e){return App.Events.once(this,t,i,e),this},unlisten:function(t){return App.Events.unlisten(this,t),this},destroy:function(){},stoodOn:null});Collection.prototype={draw:function(t){t=t||context;for(var i=0;this.items.length>i;i++)this.items[i].draw(t);return this},forEach:function(t){if("string"==typeof t)return this._executeMethod.apply(this,arguments);for(var i=this.items.length-1;i>=0;i--)t(this.items[i])&&(this.items[i].destroy instanceof Function&&this.items[i].destroy(),this.items.splice(i,1));return this},_executeMethod:function(t){Array.prototype.shift.call(arguments);for(var i=0;this.items.length>i;i++)this.items[i][t].apply(this.items[i],arguments);return this},collideAll:function(t){for(var i=!1,e=0,s=this.items.length;s>e;e++)for(var n=e+1;s>n;n++)if(this.items[e].overlaps(this.items[n])){if("function"!=typeof t)return!0;t.call(this,this.items[e],this.items[n]),i=!0}return i},add:function(t){return this.items.push(t)},concat:function(t){return this.items=this.items.concat(t),this},combine:function(t){return this.items=this.items.concat(t.items),this},remove:function(t){return this.items.remove(t)},removeLast:function(){return this.items.pop()},count:function(){return this.items.length},getAll:function(){return this.items},removeAll:function(){return this.items=[],this}};var Actor=Box.extend({MOVEAMOUNT:400,GRAVITY:!1,G_CONST:21,JUMP_VEL:500,JUMP_DELAY:.25,AIR_CONTROL:.25,JUMP_RELEASE:!1,MULTI_JUMP:0,CONTINUOUS_MOVEMENT:!1,STAY_IN_WORLD:!0,DAMPING_FACTOR:null,lastLooked:[],isBeingDragged:!1,dropTargets:new Collection,xVelocity:0,yVelocity:0,xAcceleration:0,yAcceleration:0,keys:void 0,lastJump:0,lastDirection:[],jumpDirection:{right:!1,left:!1},jumpKeyDown:!1,numJumps:0,inAir:!1,fallLeft:null,isDraggable:!1,dragStartX:0,dragStartY:0,animLoop:"",init:function(){this._super.apply(this,arguments),this.lastX=this.x,this.lastY=this.y,this.lastDirection=[],this.lastLooked=[],this.jumpDirection={right:!1,left:!1}},draw:function(){return this.src instanceof SpriteMap&&this.animLoop&&this.src.use(this.animLoop),this._super.apply(this,arguments)},drawDefault:function(t,i,e,s,n){t.drawSmiley(i+s/2,e+n/2,(s+n)/4)},update:function(t){this.lastX=this.x,this.lastY=this.y,this.isBeingDragged?(this.x=Mouse.coords.x+world.xOffset-this.width/2,this.y=Mouse.coords.y+world.yOffset-this.height/2):(this.processInput(t),this.ambientAcceleration(),this.move(),App.Utils.almostEqual(this.lastX,this.x,1e-6)&&(this.fallLeft=null),!this.GRAVITY||this.y+this.height==world.height&&this.STAY_IN_WORLD||this.startFalling()),this.updateAnimation(),this.dampVelocity()},processInput:function(t){var i=!1,e=!1,s=!1,n=App.Utils.anyIn,a=this.keys||window.keys;if(void 0!==a){if(t===void 0||0===t.length){if(!this.CONTINUOUS_MOVEMENT)return;t=this.lastLooked}if(this.lastDirection=t.slice(),n(a.left,t)?(i=!0,s=!0,this.fallLeft=!0,this.GRAVITY&&this.isInAir()?(this.jumpDirection.right||!this.jumpDirection.left)&&(this.xVelocity=-this.MOVEAMOUNT*this.AIR_CONTROL,this.jumpDirection.right=!1,this.jumpDirection.left=!1):this.xVelocity=-this.MOVEAMOUNT):n(a.right,t)&&(e=!0,s=!0,this.fallLeft=!1,this.GRAVITY&&this.isInAir()?(this.jumpDirection.left||!this.jumpDirection.right)&&(this.xVelocity=this.MOVEAMOUNT*this.AIR_CONTROL,this.jumpDirection.right=!1,this.jumpDirection.left=!1):this.xVelocity=this.MOVEAMOUNT),n(a.up,t)){if(this.GRAVITY){if(!this.isInAir()||this.MULTI_JUMP>this.numJumps||-1==this.MULTI_JUMP){var r=App.physicsTimeElapsed;!(r-this.lastJump>this.JUMP_DELAY)||this.JUMP_RELEASE&&this.jumpKeyDown||(this.yVelocity=-this.JUMP_VEL,this.yAcceleration=0,this.lastJump=r,this.jumpDirection.right=e,this.jumpDirection.left=i,this.numJumps++,this.inAir=!0)}}else this.yVelocity=-this.MOVEAMOUNT,s=!0;this.jumpKeyDown=!0}else n(a.down,t)&&(this.isInAir()&&this.GRAVITY||(this.yVelocity=this.MOVEAMOUNT,s=!0));if(s&&(this.lastLooked=t.slice(),this.GRAVITY))for(var o=this.lastLooked.length-1;o>=0;o--)-1==a.left.indexOf(this.lastLooked[o])&&-1==a.right.indexOf(this.lastLooked[o])&&this.lastLooked.splice(o,1)}},ambientAcceleration:function(){this.GRAVITY&&(this.isInAir()?(this.yAcceleration+=this.G_CONST,this.jumpDirection.left?this.xVelocity=-this.MOVEAMOUNT:this.jumpDirection.right&&(this.xVelocity=this.MOVEAMOUNT)):this.stopFalling())},move:function(){var t=App.physicsDelta,i=t/2;this.xVelocity+=this.xAcceleration*i,this.yVelocity+=this.yAcceleration*i;var e=this.xVelocity,s=this.yVelocity;if(0!==e&&0!==s&&!this.GRAVITY){var n=Math.max(Math.abs(e),Math.abs(s)),a=Math.sqrt(e*e+s*s),r=n/a;this.xVelocity*=r,this.yVelocity*=r}this.x+=this.xVelocity*t,this.y+=this.yVelocity*t,this.xVelocity+=this.xAcceleration*i,this.yVelocity+=this.yAcceleration*i,this.stayInWorld()},stayInWorld:function(){this.STAY_IN_WORLD&&(0>this.x?this.x=0:this.x+this.width>world.width&&(this.x=world.width-this.width),0>this.y?this.y=0:this.y+this.height>world.height&&(this.y=world.height-this.height,this.stopFalling()))},dampVelocity:function(){return null===this.DAMPING_FACTOR||App.Utils.almostEqual(this.xVelocity,0,1e-4)?(this.xVelocity=0,this.GRAVITY||(this.yVelocity=0),void 0):(this.xVelocity*=1-this.DAMPING_FACTOR*App.physicsDelta,this.GRAVITY||App.Utils.almostEqual(this.yVelocity,0,1e-4)||(this.yVelocity*=1-this.DAMPING_FACTOR*App.physicsDelta),void 0)},addVelocityVector:function(t,i){this.xVelocity+=i*Math.cos(t),this.yVelocity+=i*Math.sin(t)},setVelocityVector:function(t,i){this.xVelocity=i*Math.cos(t),this.yVelocity=i*Math.sin(t)},getVelocityVector:function(){return{magnitude:Math.sqrt(this.xVelocity*this.xVelocity+this.yVelocity*this.yVelocity),direction:Math.atan2(this.yVelocity,this.xVelocity)}},addAccelerationVector:function(t,i){this.xAcceleration+=i*Math.cos(t),this.yAcceleration+=i*Math.sin(t)},setAccelerationVector:function(t,i){this.xAcceleration=i*Math.cos(t),this.yAcceleration=i*Math.sin(t)},getAccelerationVector:function(){return{magnitude:Math.sqrt(this.xVelocity*this.xVelocity+this.yVelocity*this.yVelocity),direction:Math.atan2(this.yVelocity,this.xVelocity)}},moveOutside:function(t){var i=Math.min(this.x+this.width-t.x,t.x+t.width-this.x),e=Math.min(this.y+this.height-t.y,t.y+t.height-this.y);return e>=i?{x:this.moveOutsideX(t),y:this.moveOutsideY(t)}:{y:this.moveOutsideY(t),x:this.moveOutsideX(t)}},moveOutsideX:function(t){var i=0,e;return this.overlaps(t)&&(e=this.x+this.width/2<t.x+t.width/2?t.x-this.width-.01:t.x+t.width+.01,i=e-this.x,this.x=e),i},moveOutsideY:function(t){var i=0,e;return this.overlaps(t)&&(e=this.y+this.height/2<=t.y+t.height/2?t.y-this.height-1:t.y+t.height+1,i=e-this.y,this.y=e),i},startFalling:function(){this.inAir||null===this.fallLeft||(this.jumpDirection.left=this.fallLeft,this.jumpDirection.right=!this.fallLeft),this.inAir=!0},stopFalling:function(){this.yAcceleration>0&&(this.yAcceleration=0),this.yVelocity>0&&(this.yVelocity=0),this.numJumps=0,this.inAir=!1},isInAir:function(){return this.inAir},isJumping:function(){return this.numJumps>0},isFalling:function(){return this.isInAir()&&0===this.numJumps},hasAirMomentum:function(){return null!==this.fallLeft||this.jumpDirection.left||this.jumpDirection.right},standingOn:function(t){if(t instanceof Collection||t instanceof TileMap){for(var i=t.getAll(),e=0,s=i.length;s>e;e++)if(this.standingOn(i[e]))return!0;return!1}return this.overlapsX(t)&&App.Utils.almostEqual(this.y+this.height,t.y,1)},collideSolid:function(t){var i={x:0,y:0};if(t instanceof Box)i=this._collideSolidBox(t);else if(t instanceof Collection||t instanceof TileMap)for(var e=t.getAll(),s=0,n=e.length;n>s;s++){var a=this._collideSolidBox(e[s]);a.x&&(i.x=a.x),a.y&&(i.y=a.y)}return i.x=!!i.x,i.y=!!i.y,this.updateAnimation(i),i},_collideSolidBox:function(t){var i=!0,e={x:0,y:0};if(this.overlaps(t)&&(e=this.moveOutside(t)),this.GRAVITY){var s=this.x;this.x=this.lastX,this.standingOn(t)&&(this.stopFalling(),i=!1,"function"==typeof t.stoodOn&&t.stoodOn(this)),this.x=s,i&&(e.x||e.y)&&(App.Utils.almostEqual(this.y,t.y+t.height,1)?(0>this.yAcceleration&&(this.yAcceleration=0),0>this.yVelocity&&(this.yVelocity=0)):(this.jumpDirection.left=!1,this.jumpDirection.right=!1))}return e},updateAnimation:function(t){if(this.src instanceof SpriteMap){var i=this.keys||window.keys,e=this.lastDirection,s=i!==void 0;s&&i.shoot!==void 0&&App.Utils.anyIn(i.shoot,e)&&(e=this.lastLooked),this.isBeingDragged?this.useAnimation("drag","stand"):this.isInAir()?this.x>this.lastX?this.useAnimation("jumpRight","lookRight","stand"):this.x<this.lastX?this.useAnimation("jumpLeft","lookLeft","stand"):this.isJumping()?this.useAnimation("jump","stand"):this.useAnimation("fall","stand"):this.y>this.lastY?this.x>this.lastX?this.useAnimation("downRight","stand"):this.x<this.lastX?this.useAnimation("downLeft","stand"):this.useAnimation("down","stand"):this.y<this.lastY?this.x>this.lastX?this.useAnimation("upRight","stand"):this.x<this.lastX?this.useAnimation("upLeft","stand"):this.useAnimation("up","stand"):this.x>this.lastX?this.useAnimation("right","stand"):this.x<this.lastX?this.useAnimation("left","stand"):s&&App.Utils.anyIn(i.up,e)?App.Utils.anyIn(i.right,e)?this.useAnimation("lookUpRight","stand"):App.Utils.anyIn(i.left,e)?this.useAnimation("lookUpLeft","stand"):this.useAnimation("lookUp","stand"):s&&App.Utils.anyIn(i.down,e)?App.Utils.anyIn(i.right,e)?this.useAnimation("lookDownRight","stand"):App.Utils.anyIn(i.left,e)?this.useAnimation("lookDownLeft","stand"):this.useAnimation("lookDown","stand"):s&&App.Utils.anyIn(i.right,e)?this.useAnimation(t&&t.x?"right":"lookRight","stand"):s&&App.Utils.anyIn(i.left,e)?this.useAnimation(t&&t.x?"left":"lookLeft","stand"):this.useAnimation("stand")}},useAnimation:function(){for(var t=0;arguments.length>t;t++){var i=arguments[t];if(this.src.maps[i])return this.animLoop=i,i}return!1},setDraggable:function(t){if(!this.isDraggable||!t){if(!t)return this.isDraggable=!1,this.unlisten(".drag"),void 0;this.isDraggable=!0,this.listen("mousedown.drag touchstart.drag",function(){App.isSomethingBeingDragged=!0,this.isBeingDragged=!0,this.dragStartX=this.x,this.dragStartY=this.y,jQuery(document).trigger("canvasdragstart",[this])}),this.listen("canvasdragstop.drag",function(){this.isBeingDragged=!1;var t=this.collides(this.dropTargets);this.dropTargets.count()&&!t?(this.x=this.dragStartX,this.y=this.dragStartY):t&&jQuery(document).trigger("canvasdrop",[t])})}},getDraggable:function(){return this.isDraggable},release:function(t){var i=this.keys||window.keys;this.GRAVITY&&i!==void 0&&App.Utils.anyIn(i.up,t)&&(this.jumpKeyDown=!1)}}),Player=Actor.extend({MOVEWORLD:.45,JUMP_RELEASE:!0,init:function(){this._super.apply(this,arguments),arguments.length>0&&world.centerViewportAround(this.x,this.y);var t=this;this.__keytracker=function(){t.release([jQuery.hotkeys.lastKeyPressed()])},jQuery(document).on("keyup.release",this.__keytracker)},processInput:function(t){return void 0===t&&(t=jQuery.hotkeys.keysDown),this._super(t)},update:function(t){this._super(t),this.isBeingDragged||this.adjustViewport()},setDraggable:function(t){t&&!this.isDraggable&&this.listen("canvasdragstop.drag",function(){!this.isBeingDragged||this.dropTargets.count()&&!this.collides(this.dropTargets)||world.centerViewportAround(this.x,this.y)},-1),this._super.apply(this,arguments)},adjustViewport:function(){var t=world.getOffsets(),i={x:0,y:0};return Mouse.Scroll.isEnabled()?i:(t.x>0&&this.x+this.width/2-t.x<canvas.width*this.MOVEWORLD?(world.xOffset=Math.max(t.x+(this.x-this.lastX),0),context.translate(t.x-world.xOffset,0),i.x=t.x-world.xOffset):t.x<world.width-canvas.width&&this.x+this.width/2-t.x>canvas.width*(1-this.MOVEWORLD)&&(world.xOffset=Math.min(t.x+(this.x-this.lastX),world.width-canvas.width),context.translate(t.x-world.xOffset,0),i.x=t.x-world.xOffset),t.y>0&&this.y+this.height/2-t.y<canvas.height*this.MOVEWORLD?(world.yOffset=Math.max(t.y+(this.y-this.lastY),0),context.translate(0,t.y-world.yOffset),i.y=t.y-world.yOffset):t.y<world.height-canvas.height&&this.y+this.height/2-t.y>canvas.height*(1-this.MOVEWORLD)&&(world.yOffset=Math.min(t.y+(this.y-this.lastY),world.height-canvas.height),context.translate(0,t.y-world.yOffset),i.y=t.y-world.yOffset),i)},destroy:function(){this._super.apply(this,arguments),jQuery(document).off(".release",this.__keytracker)}});
/*
//@ sourceMappingURL=combined.min.map
*/